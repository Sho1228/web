<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Anonymous Chat - Complete Version</title>
  <style>
    :root {
      --bg-color: #f4f7f6;
      --text-color: black;
      --chat-bg: #fafafa;
      --msg-bg: #e0f7fa;
    }
    body.dark-mode {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --chat-bg: #1e1e1e;
      --msg-bg: #333333;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .chat-container {
      background: var(--bg-color);
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      width: 400px;
      max-width: 90%;
      padding: 20px;
      display: flex;
      flex-direction: column;
      color: var(--text-color);
    }
    #chat {
      border: 1px solid #ddd;
      border-radius: 5px;
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      background-color: var(--chat-bg);
      margin-bottom: 10px;
    }
    #chat div {
      background-color: var(--msg-bg);
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 5px;
    }
    #input-area {
      display: flex;
    }
    #message {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-right: 10px;
      color: var(--text-color);
      background-color: var(--chat-bg);
    }
    #send {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #send:hover {
      background-color: #45a049;
    }
    #errorMessage {
      color: red;
      font-size: 14px;
      margin-top: 5px;
    }
    #notificationToggle, #themeToggle {
      margin-top: 10px;
      padding: 5px 10px;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #icon {
      width: 20px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <h2>Anonymous Chat</h2>
    <div id="chat"></div>
    <div id="input-area">
      <input type="text" id="message" placeholder="Type your message...">
      <button id="send">Send</button>
    </div>
    <div id="errorMessage"></div>
    <button id="notificationToggle">Enable Notifications</button>
    <button id="themeToggle">
      <img id="icon" src="https://cdn-icons-png.flaticon.com/512/869/869869.png" alt="Theme">
      Toggle Dark/Light Mode
    </button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDmAXqX2yMJ_qTgkVQXQKNGqwFrt1lydHc",
      authDomain: "website-90fc2.firebaseapp.com",
      databaseURL: "https://website-90fc2-default-rtdb.firebaseio.com",
      projectId: "website-90fc2",
      storageBucket: "website-90fc2.appspot.com",
      messagingSenderId: "154304899755",
      appId: "1:154304899755:web:6859d1636b54ff49f8a5ee"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let userName = localStorage.getItem("chatUserName");
    if (!userName) {
      userName = prompt("Enter your name:") || "Anonymous";
      localStorage.setItem("chatUserName", userName);
    }

    const chat = document.getElementById("chat");
    const messageInput = document.getElementById("message");
    const sendButton = document.getElementById("send");
    const errorMessage = document.getElementById("errorMessage");
    const notificationToggle = document.getElementById("notificationToggle");
    const themeToggle = document.getElementById("themeToggle");
    const icon = document.getElementById("icon");

    let canSend = true;
    let notificationsEnabled = localStorage.getItem("notifications") === "true";

    // Update notification button text
    notificationToggle.textContent = notificationsEnabled ? "Disable Notifications" : "Enable Notifications";

    // Load saved theme
    if (localStorage.getItem("theme") === "dark") {
      document.body.classList.add("dark-mode");
      icon.src = "https://cdn-icons-png.flaticon.com/512/2721/2721285.png";
    }

    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      if (document.body.classList.contains("dark-mode")) {
        icon.src = "https://cdn-icons-png.flaticon.com/512/2721/2721285.png"; // Moon
        localStorage.setItem("theme", "dark");
      } else {
        icon.src = "https://cdn-icons-png.flaticon.com/512/869/869869.png"; // Sun
        localStorage.setItem("theme", "light");
      }
    });

    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        sendMessage();
      }
    });

    sendButton.addEventListener("click", sendMessage);

    notificationToggle.addEventListener("click", () => {
      if ("Notification" in window) {
        if (Notification.permission === "granted") {
          notificationsEnabled = !notificationsEnabled;
          notificationToggle.textContent = notificationsEnabled ? "Disable Notifications" : "Enable Notifications";
          localStorage.setItem("notifications", notificationsEnabled);
        } else if (Notification.permission === "default") {
          Notification.requestPermission().then((permission) => {
            if (permission === "granted") {
              notificationsEnabled = true;
              notificationToggle.textContent = "Disable Notifications";
              localStorage.setItem("notifications", true);
            }
          });
        } else {
          alert("Notifications are blocked. Please enable them in your browser settings.");
        }
      }
    });

    function sendMessage() {
      if (!canSend) {
        showError("Please wait 1 second before sending another message.");
        return;
      }

      const msg = messageInput.value.trim();
      if (msg) {
        db.ref("messages").push({ name: userName, text: msg, time: Date.now() });
        messageInput.value = "";
        canSend = false;
        setTimeout(() => {
          canSend = true;
          clearError();
        }, 1000);
      }
    }

    function showError(msg) {
      errorMessage.textContent = msg;
    }

    function clearError() {
      errorMessage.textContent = "";
    }

    db.ref("messages").on("child_added", function(snapshot) {
      const msg = snapshot.val();
      const msgDiv = document.createElement("div");
      const time = new Date(msg.time).toLocaleTimeString();
      msgDiv.textContent = `[${time}] ${msg.name}: ${msg.text}`;
      chat.appendChild(msgDiv);
      chat.scrollTop = chat.scrollHeight;

      if (notificationsEnabled && msg.name !== userName) {
        new Notification(`New message from ${msg.name}`, {
          body: msg.text,
          icon: "https://cdn-icons-png.flaticon.com/512/565/565547.png"
        });
      }
    });

    async function saveIP() {
      try {
        const response = await fetch("https://api.ipify.org?format=json");
        const data = await response.json();
        const ip = data.ip;
        db.ref("ips").push({ name: userName, ip: ip, time: Date.now() });
      } catch (error) {
        console.error("Failed to get IP:", error);
      }
    }

    saveIP();
    setInterval(saveIP, 20 * 60 * 1000);
  </script>
</body>
</html>
